{"version":3,"file":"simpleAjax.js","sources":["../src/Ajax/index.ts"],"sourcesContent":["/*\n * @Author: raojw\n * @Description: 迷你ajax工具\n */\n\nexport interface SimpleAjaxConfig {\n  method: 'get' | 'post' | 'put' | 'delete';\n  url: string;\n  withCredentials?: boolean;\n  responseType?: 'json' | 'text' | 'blob' | 'document' | 'arraybuffer';\n  headers?: object;\n  timeout?: number;\n  params?: object;\n  data?: any;\n  onDownloadProgress?: (this: XMLHttpRequest, ev: any) => void;\n  onUploadProgress?: (this: XMLHttpRequestUpload, ev: any) => void;\n  validateStatus?: (status: number) => boolean;\n}\n\nfunction SimpleAjax(config: SimpleAjaxConfig) {\n  const toString = Object.prototype.toString;\n\n  const isObject = (val: any) => toString.call(val) === '[object Object]';\n  const isArray = (val: any) => Array.isArray(val);\n  const isDate = (val: any) => toString.call(val) === '[object Date]';\n  const isFunction = (val: any) => typeof val === 'function';\n  const isBoolean = (val: any) => typeof val === 'boolean';\n  const isFormData = (val: any) => typeof FormData !== 'undefined' && val instanceof FormData;\n  const isNumber = (val: any) => typeof val === 'number';\n\n  // 编码\n  const encode = (val: string) => {\n    return encodeURIComponent(val)\n      .replace(/%40/gi, '@')\n      .replace(/%3A/gi, ':')\n      .replace(/%24/g, '$')\n      .replace(/%2C/gi, ',')\n      .replace(/%20/g, '+')\n      .replace(/%5B/gi, '[')\n      .replace(/%5D/gi, ']');\n  };\n\n  // 序列化参数\n  const serializedParamsUtil = (params: object) => {\n    let res;\n\n    const parts: string[] = [];\n\n    Object.keys(params).forEach(function(key) {\n      let val = params[key];\n      if (val === null || typeof val === 'undefined') {\n        return;\n      }\n\n      if (isArray(val)) {\n        key = key + '[]';\n      }\n\n      if (isDate(val)) {\n        val = val.toISOString();\n      } else if (isObject(val)) {\n        val = JSON.stringify(val);\n      }\n\n      parts.push(encode(key) + '=' + encode(val));\n    });\n\n    res = parts.join('&');\n\n    return res;\n  };\n\n  const buildURL = function(url: string, params: any) {\n    if (!params) {\n      return url;\n    }\n\n    const serializedParams = serializedParamsUtil(params);\n\n    if (serializedParams) {\n      const hashmarkIndex = url.indexOf('#');\n      if (hashmarkIndex !== -1) {\n        url = url.slice(0, hashmarkIndex);\n      }\n      url += (url.indexOf('?') === -1 ? '?' : '&') + serializedParams;\n    }\n\n    return url;\n  };\n\n  // 默认参数\n  const defaultConfig: SimpleAjaxConfig = {\n    method: 'get',\n    url: '',\n    withCredentials: false,\n    responseType: 'json',\n    data: null,\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded;charset=utf-8'\n    },\n    timeout: 0,\n    validateStatus(status) {\n      return status !== 0; // 状态码验证，默认不为0的都resolve\n    }\n    // params: {},\n    // onDownloadProgress: undefined,\n    // onUploadProgress: undefined\n  };\n\n  config = Object.assign({}, defaultConfig, config);\n\n  return new Promise((resolve, reject) => {\n    const {\n      method,\n      url,\n      data,\n      params,\n      headers,\n      timeout,\n      withCredentials,\n      responseType,\n      onDownloadProgress,\n      onUploadProgress,\n      validateStatus\n    } = config;\n\n    let reqData = data;\n    const reqHeaders = headers;\n\n    if (isFormData(reqData)) {\n      if (reqHeaders && 'Content-Type' in reqHeaders) {\n        delete reqHeaders['Content-Type'];\n      }\n    }\n\n    if (isObject(data) && reqHeaders) {\n      reqHeaders['Content-Type'] = 'application/json;charset=utf-8';\n    }\n\n    const request = new XMLHttpRequest();\n\n    request.open(method.toUpperCase(), buildURL(url, params), true);\n\n    if (isBoolean(withCredentials) && withCredentials !== undefined) {\n      request.withCredentials = withCredentials;\n    }\n\n    onDownloadProgress &&\n      isFunction(onDownloadProgress) &&\n      request.addEventListener('progress', onDownloadProgress);\n    onUploadProgress &&\n      isFunction(onUploadProgress) &&\n      request.upload.addEventListener('progress', onUploadProgress);\n\n    headers &&\n      isObject(headers) &&\n      Object.keys(headers).forEach(function(key) {\n        request.setRequestHeader(key, headers[key]);\n      });\n\n    timeout && isNumber(timeout) && (request.timeout = timeout);\n\n    request.onreadystatechange = function handleOnLoad() {\n      if (request.readyState === 4) {\n        const responseData = responseType === 'text' ? request.responseText : request.response;\n        const responseHeaders = request.getAllResponseHeaders();\n\n        const response = {\n          data: responseData,\n          status: request.status,\n          requset: request,\n          responseHeaders,\n          config\n        };\n\n        if (validateStatus && validateStatus(request.status)) {\n          resolve(response);\n        } else {\n          const error = new Error(`Request failed with status code` + request.status);\n          // @ts-ignore\n          error.requset = request;\n          // @ts-ignore\n          error.response = response;\n\n          reject(error);\n        }\n      }\n    };\n\n    request.onerror = function handleError() {\n      reject(new Error('Network Error'));\n    };\n\n    if (isObject(reqData)) {\n      reqData = JSON.stringify(reqData);\n    }\n\n    request.send(reqData);\n  });\n}\n\nSimpleAjax.version = '1.0.0';\n\nexport default SimpleAjax;\n"],"names":[],"mappings":"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"}